// This is your Prisma schema file
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model OutboundUpload {
  id         String   @id @default(uuid())
  fileName   String   @map("file_name")
  uploadedAt DateTime @default(now()) @map("uploaded_at")
  status     String   @default("processed") // processed, failed
  source     String   @default("manual-upload")
  rows       OutboundRow[]

  @@map("outbound_uploads")
}

enum NormalizedCategory {
  E_COMMERCE
  OFFLINE
  QUICK_COMMERCE
  EBO
  B2C
  OTHERS
}

enum ProductCategory {
  EDEL
  HOME_AND_KITCHEN
  ELECTRONICS
  HEALTH_AND_PERSONAL_CARE
  AUTOMOTIVE_AND_TOOLS
  TOYS_AND_GAMES
  BRAND_PRIVATE_LABEL
  OTHERS
}

model OutboundRow {
  id                  String             @id @default(uuid())
  uploadId            String             @map("upload_id")
  customerGroup       String?            @map("customer_group")
  sourceWarehouse     String?            @map("source_warehouse")
  soItem              String?            @map("so_item")
  categoryRaw         String?            @map("category_raw")
  salesOrderQty       Float              @default(0) @map("sales_order_qty")
  soTotalCbm          Float              @default(0) @map("so_total_cbm")
  deliveryNoteDate    DateTime?          @map("delivery_note_date")
  deliveryNoteItem    String?            @map("delivery_note_item")
  deliveryNoteQty     Float              @default(0) @map("delivery_note_qty")
  dnTotalCbm          Float              @default(0) @map("dn_total_cbm")
  transporter         String?
  normalizedCategory  NormalizedCategory @map("normalized_category")
  productCategory     ProductCategory    @default(OTHERS) @map("product_category")
  createdAt           DateTime           @default(now()) @map("created_at")

  upload OutboundUpload @relation(fields: [uploadId], references: [id], onDelete: Cascade)

  @@index([uploadId])
  @@index([deliveryNoteDate])
  @@index([normalizedCategory])
  @@index([productCategory])
  @@map("outbound_rows")
}

model ItemMaster {
  id           String   @id         // master ID (from column B)
  itemGroup    String   @map("item_group") // Item Group (D)
  cbmPerUnit   Float    @default(0) @map("cbm_per_unit") // CBM (H), default 0 if invalid
  createdAt    DateTime @default(now()) @map("created_at")

  @@map("item_master")
}

model InboundUpload {
  id          String   @id @default(uuid())
  fileName    String   @map("file_name")
  uploadedAt  DateTime @default(now()) @map("uploaded_at")
  status      String   @default("processed") // "processed" | "failed"
  source      String   @default("manual-upload")
  rows        InboundRow[]

  @@map("inbound_uploads")
}

model InboundRow {
  id             String        @id @default(uuid())
  uploadId       String        @map("upload_id")
  upload         InboundUpload @relation(fields: [uploadId], references: [id], onDelete: Cascade)

  dateOfUnload   DateTime?     @map("date_of_unload")
  invoiceSku     String?       @map("invoice_sku")
  receivedSku    String?       @map("received_sku")
  invoiceQty     Float         @default(0) @map("invoice_qty")
  receivedQty    Float         @default(0) @map("received_qty")
  goodQty        Float         @default(0) @map("good_qty")

  // joined from ItemMaster based on receivedSku == ItemMaster.id
  itemGroup      String?       @map("item_group") // Item Group (D), or "Others" if not found
  cbmPerUnit     Float         @default(0) @map("cbm_per_unit")
  totalCbm       Float         @default(0) @map("total_cbm")

  createdAt      DateTime      @default(now()) @map("created_at")

  @@index([uploadId])
  @@index([dateOfUnload])
  @@index([itemGroup])
  @@map("inbound_rows")
}

// ============================================
// Phase 4 - Inventory Models
// ============================================

model InventoryUpload {
  id          String           @id @default(uuid())
  fileName    String           @map("file_name")
  uploadedAt  DateTime         @default(now()) @map("uploaded_at")
  status      String           @default("processing") // "processing" | "processed" | "failed"
  source      String           @default("manual-upload")

  rows        InventoryRow[]

  @@map("inventory_uploads")
}

model InventoryRow {
  id           String              @id @default(uuid())
  uploadId     String              @map("upload_id")
  upload       InventoryUpload     @relation(fields: [uploadId], references: [id], onDelete: Cascade)

  item         String              // A - Item name
  warehouse    String              // C - Warehouse
  itemGroup    String              @map("item_group") // D - Item Group
  cbmPerUnit   Float               @default(0) @map("cbm_per_unit") // G - CBM per unit
  isTotalRow   Boolean             @default(false) @map("is_total_row") // True if this is the "Total" row

  dailyStocks  InventoryDailyStock[]

  createdAt    DateTime            @default(now()) @map("created_at")

  @@index([uploadId])
  @@index([itemGroup])
  @@map("inventory_rows")
}

model InventoryDailyStock {
  id             String        @id @default(uuid())
  inventoryRowId String        @map("inventory_row_id")
  inventoryRow   InventoryRow  @relation(fields: [inventoryRowId], references: [id], onDelete: Cascade)

  stockDate      DateTime      @map("stock_date")
  quantity       Float         @default(0)

  createdAt      DateTime      @default(now()) @map("created_at")

  @@index([inventoryRowId])
  @@index([stockDate])
  @@map("inventory_daily_stock")
}
